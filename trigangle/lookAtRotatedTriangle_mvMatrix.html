<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>3d 模型视图矩阵x顶点坐标旋转 三角形</title>
  </head>
  <body onload="main()">
    <canvas id="webgl" width="400" height="400">
      Your browser doesn't appear to support the HTML5
      <code>&lt;canvas&gt;</code> element.
    </canvas>
  </body>
</html>
<script src="../lib/webgl-utils.js"></script>
<script src="../lib/webgl-debug.js"></script>
<script src="../lib/cuon-matrix.js"></script>
<script src="../lib/cuon-utils.js"></script>
<script>
  // LookAtTriangles.js (c) 2012 matsuda
  // Vertex shader program
  var VSHADER_SOURCE =
    'attribute vec4 a_Position;\n' +
    'attribute vec4 a_Color;\n' +
    'uniform mat4 u_ViewMatrix;\n' +
    'uniform mat4 u_ModelMatrix;\n' +
    'uniform mat4 u_ModelViewMatrix;\n' +
    'varying vec4 v_Color;\n' +
    'void main() {\n' +
    '  gl_Position = u_ModelViewMatrix * a_Position;\n' +
    '  v_Color = a_Color;\n' +
    '}\n'

  // Fragment shader program
  var FSHADER_SOURCE =
    '#ifdef GL_ES\n' +
    'precision mediump float;\n' +
    '#endif\n' +
    'varying vec4 v_Color;\n' +
    'void main() {\n' +
    '  gl_FragColor = v_Color;\n' +
    '}\n'

  function main() {
    // Retrieve <canvas> element
    var canvas = document.getElementById('webgl')

    // Get the rendering context for WebGL
    var gl = getWebGLContext(canvas)
    if (!gl) {
      console.log('Failed to get the rendering context for WebGL')
      return
    }

    // Initialize shaders
    if (!initShaders(gl, VSHADER_SOURCE, FSHADER_SOURCE)) {
      console.log('Failed to intialize shaders.')
      return
    }

    // Set the vertex coordinates and color (the blue triangle is in the front)
    var n = initVertexBuffers(gl)
    if (n < 0) {
      console.log('Failed to set the vertex information')
      return
    }

    // Specify the color for clearing <canvas>
    gl.clearColor(0, 0, 0, 1)

    // Get the storage location of u_ViewMatrix
    var u_ModelViewMatrix = gl.getUniformLocation(
      gl.program,
      'u_ModelViewMatrix'
    )
    if (!u_ModelViewMatrix) {
      console.log('Failed to get the storage locations of u_ModelViewMatrix')
      return
    }

    // Set the matrix to be used for to set the camera view
    var viewMatrix = new Matrix4()
    viewMatrix.setLookAt(0.2, 0.25, 0.25, 0, 0, 0, 0, 1, 0)

    // 计算旋转矩阵
    let modelMatrix = new Matrix4()
    modelMatrix.setRotate(-10, 0, 0, 1)

    // 两个矩阵相乘
    let modelViewMatrix = viewMatrix.multiply(modelMatrix)

    // Set the view matrix
    gl.uniformMatrix4fv(u_ModelViewMatrix, false, modelViewMatrix.elements)

    // Clear <canvas>
    gl.clear(gl.COLOR_BUFFER_BIT)

    // Draw the rectangle
    gl.drawArrays(gl.TRIANGLES, 0, n)
  }

  function initVertexBuffers(gl) {
    var verticesColors = new Float32Array([
      // Vertex coordinates and color(RGBA)
      0.0,
      0.5,
      -0.4,
      0.4,
      1.0,
      0.4, // The back green one
      -0.5,
      -0.5,
      -0.4,
      0.4,
      1.0,
      0.4,
      0.5,
      -0.5,
      -0.4,
      1.0,
      0.4,
      0.4,

      0.5,
      0.4,
      -0.2,
      1.0,
      0.4,
      0.4, // The middle yellow one
      -0.5,
      0.4,
      -0.2,
      1.0,
      1.0,
      0.4,
      0.0,
      -0.6,
      -0.2,
      1.0,
      1.0,
      0.4,

      0.0,
      0.5,
      0.0,
      0.4,
      0.4,
      1.0, // The front blue one
      -0.5,
      -0.5,
      0.0,
      0.4,
      0.4,
      1.0,
      0.5,
      -0.5,
      0.0,
      1.0,
      0.4,
      0.4
    ])
    var n = 9

    // Create a buffer object
    var vertexColorbuffer = gl.createBuffer()
    if (!vertexColorbuffer) {
      console.log('Failed to create the buffer object')
      return -1
    }

    // Write the vertex coordinates and color to the buffer object
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexColorbuffer)
    gl.bufferData(gl.ARRAY_BUFFER, verticesColors, gl.STATIC_DRAW)

    var FSIZE = verticesColors.BYTES_PER_ELEMENT
    // Assign the buffer object to a_Position and enable the assignment
    var a_Position = gl.getAttribLocation(gl.program, 'a_Position')
    if (a_Position < 0) {
      console.log('Failed to get the storage location of a_Position')
      return -1
    }
    gl.vertexAttribPointer(a_Position, 3, gl.FLOAT, false, FSIZE * 6, 0)
    gl.enableVertexAttribArray(a_Position)

    // Assign the buffer object to a_Color and enable the assignment
    var a_Color = gl.getAttribLocation(gl.program, 'a_Color')
    if (a_Color < 0) {
      console.log('Failed to get the storage location of a_Color')
      return -1
    }
    gl.vertexAttribPointer(a_Color, 3, gl.FLOAT, false, FSIZE * 6, FSIZE * 3)
    gl.enableVertexAttribArray(a_Color)

    // Unbind the buffer object
    gl.bindBuffer(gl.ARRAY_BUFFER, null)

    return n
  }
</script>
